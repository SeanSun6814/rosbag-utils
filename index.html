<html>

<head>
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="/lib/swal/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css">
</head>

<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title"><b>Rosbag Utils</b></span>
            <nav class="mdl-navigation">
                <a id="nav1" class="mdl-navigation__link" href="javascript:void(0);" onclick="showPanel(1);">
                </a>
                <a id="nav2" class="mdl-navigation__link" href="javascript:void(0);" onclick="showPanel(2);">
                </a>
                <a id="nav3" class="mdl-navigation__link" href="javascript:void(0);" onclick="showPanel(3);">
                </a>
                <a id="nav4" class="mdl-navigation__link" href="javascript:void(0);" onclick="showPanel(4);">
                </a>
            </nav>
        </div>
        <main class="mdl-layout__content">
            <div class="page-content">
                <div id="panel0">
                    <div class="demo-card-wide mdl-card mdl-shadow--2dp center">
                        <div class="mdl-card__title">
                            <h2 class="mdl-card__title-text">Welcome</h2>
                        </div>
                        <div class="mdl-card__supporting-text">
                            Rosbag utils can help you filter out the useful topics from multiple rosbags. We'll also
                            generate some important statistics about your data.
                        </div>
                        <div class="mdl-card__actions mdl-card--border">
                            <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
                                href="javascript:void(0);" onclick="showPanel(1);">
                                Get Started
                            </a>
                        </div>
                    </div>
                </div>
                <div id="panel1" style="display: none;">
                    <div class="row">
                        <div class="column">
                            <div class="" style="top:10%;">
                                <h2>Import files</h2>
                                <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                                    <thead>
                                        <tr>
                                            <th class="mdl-data-table__cell--non-numeric">Files</th>
                                            <!-- <th>Quantity</th>
                                            <th>Unit price</th> -->
                                        </tr>
                                    </thead>
                                    <tbody id="fileTable">

                                    </tbody>
                                </table>
                                <br><br>
                                <button id="addBagBtn"
                                    class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect"
                                    onclick="showFileDialog();">
                                    Add file
                                </button>
                                <br><br><br>
                                <div id="oneRunSwitchDiv">
                                    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="oneRunSwitch">
                                        <input type="checkbox" id="oneRunSwitch" onchange="checkTreatAsOneRun()"
                                            class="mdl-switch__input" checked>
                                        <span class="mdl-switch__label">Treat as one run</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="" style="top:10%;">
                                <h2>Bag info</h2>
                                <p id="bagName"></p>
                                <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                                    <thead>
                                        <tr>
                                            <th class="mdl-data-table__cell--non-numeric">Topic</th>
                                            <th class="mdl-data-table__cell--non-numeric">Type</th>
                                            <th class="mdl-data-table__cell--non-numeric">Messages</th>
                                            <th class="mdl-data-table__cell--non-numeric">Frequency</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bagInfoTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="panel2" style="display: none;">
                    <div class="" style="top: 10%; padding-left: 7%;">
                        <h2>Select the topics to keep</h2>
                        <table id="allTopicsTableOuter" class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                            <thead>
                                <tr>
                                    <th>
                                        <label
                                            class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select"
                                            for="table-header">
                                            <input type="checkbox" id="table-header" class="mdl-checkbox__input" />
                                        </label>
                                    </th>
                                    <th class="mdl-data-table__cell--non-numeric">Topic</th>
                                    <th class="mdl-data-table__cell--non-numeric">Type</th>
                                    <th class="mdl-data-table__cell--non-numeric">Total # messages</th>
                                    <th class="mdl-data-table__cell--non-numeric">Appeared in # bags</th>
                                </tr>
                            </thead>
                            <tbody id="allTopicsTable">
                            </tbody>
                        </table>
                        <p id="bagDiffWarning" style="color: red;"></p>
                    </div>
                </div>
                <div id="panel3" style="display: none;">
                    <div style="top: 10%; padding-left: 7%;">
                        <h2>Remove standstill data at start</h2>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="standstillSwitch">
                            <input type="checkbox" id="standstillSwitch" class="mdl-switch__input"
                                onchange="checkEnableStandstill();">
                            <span class="mdl-switch__label" id="standstillSwitchLabel">Enabled</span>
                        </label>
                        <form action="#" class="disabled">
                            <h4>Keep how many seconds of standstill data</h4>
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                    id="standstillTimeInput" value="30" size="10">
                                <label class="mdl-textfield__label" for="standstillTimeInput">Seconds...</label>
                                <span class="mdl-textfield__error">Input is not a number!</span>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="panel4" style="display: none;">
                    <p>Yay</p>
                </div>
            </div>
        </main>
    </div>
    <div class="mdl-tooltip" data-mdl-for="addBagBtn">
        Import rosbag files to process
    </div>
    <div class="mdl-tooltip" data-mdl-for="fileTable">
        Click on bag to view info
    </div>
    <div class="mdl-tooltip" data-mdl-for="oneRunSwitchDiv">
        Treat all the files as one continuous run that was just split in multiple files. (The files must be sorted
        correctly!)
    </div>
</body>
<script>
    let files = [];
    let topics = [];
    let selectedTopics = [];

    function showPanel(panelIdx) {
        for (let i = 0; i < 5; i++) {
            document.getElementById("panel" + i).style.display = (panelIdx === i ? "block" : "none");
            if (i > 0) document.getElementById("nav" + i).style.backgroundColor = (panelIdx === i ? "rgb(224, 224, 224)" : "rgb(250, 250, 250)");
        }
        if (panelIdx === 2) onShowPanel2();
    }

    function onShowPanel2() {
        // if (files.length === 0) {
        //     return showAlert('No bag files', "Let's import some bag files first!", 'warning', 'Got it!', () => { showPanel(1); })
        // }

        function getAllTopics() {
            let allTopics = {};
            let allTheSame = true;
            for (let fileIdx = 0; fileIdx < files.length; fileIdx++) {
                let info = files[fileIdx].info[1];
                let topicCount = 0;
                for (let topic in info) {
                    topicCount++;
                    if (allTopics[topic] == undefined) {
                        if (fileIdx != 0) allTheSame = false;
                        allTopics[topic] = [topic, info[topic][0], info[topic][1], 1]
                    } else {
                        if (info[topic][0] !== allTopics[topic][1]) {
                            alert("Sneaky! Some topics have same names but different types!\n" +
                                "This display might only show one type but everything else should work though. " +
                                "This part of the code is not tested, so double check the results.");
                        }
                        allTopics[topic][2] += info[topic][1];
                        allTopics[topic][3] += 1;
                    }
                }
                if (topicCount != Object.keys(allTopics).length) {
                    allTheSame = false;
                }
            }
            let arr = [];
            for (var key in allTopics) {
                if (allTopics.hasOwnProperty(key)) {
                    arr.push(allTopics[key]);
                }
            }
            return { arr: arr, topicsAllTheSame: allTheSame };
        }
        let result = getAllTopics();
        if (!result.topicsAllTheSame) {
            document.getElementById("bagDiffWarning").innerHTML = `<br><i class="fa fa-info-circle fa-lg" aria-hidden="true"></i> &nbsp Some bags have different topics.`;
        } else {
            document.getElementById("bagDiffWarning").innerHTML = `<br><i class="fa fa-info-circle fa-lg" aria-hidden="true"></i> &nbsp All bags have the same topics.`;
        }
        let table = document.getElementById("allTopicsTable");
        table.innerHTML = "";
        let rowIdx = 1;
        let checkbox = "";//`<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select mdl-js-ripple-effect--ignore-events is-upgraded" data-upgraded=",MaterialCheckbox,MaterialRipple"><input type="checkbox" class="mdl-checkbox__input"><span class="mdl-checkbox__focus-helper"></span><span class="mdl-checkbox__box-outline"><span class="mdl-checkbox__tick-outline"></span></span><span class="mdl-checkbox__ripple-container mdl-js-ripple-effect mdl-ripple--center" data-upgraded=",MaterialRipple"><span class="mdl-ripple"></span></span></label>`;
        for (let arr in result.arr) {
            checkbox = `<label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select" for="row${rowIdx}">
                <input type="checkbox" id="row${rowIdx}" class="mdl-checkbox__input" />
              </label>`;
            rowIdx++;
            addToTable(table, [checkbox].concat(result.arr[arr]));
        }
        allTopicsTableItemCount = rowIdx - 1;
        componentHandler.upgradeDom();
        let itemChecks = allTopicsTable.querySelectorAll('tbody .mdl-data-table__select input');
        itemChecks.forEach((elem) => elem.addEventListener('change', itemCheckHandler));
    }

    function addToTable(table, dataArr, onclick) {
        if (onclick === undefined) onclick = "";
        let html = "<tr>";
        dataArr.forEach((elem, idx, arr) => {
            if (typeof elem === "string")
                html += "<td onclick='" + onclick + "' class=\"mdl-data-table__cell--non-numeric\">" + elem + "</td>";
            else
                html += "<td onclick='" + onclick + "'>" + elem + "</td>";
        });
        html += "</tr>";
        table.innerHTML += html;
    }

    function showBagInfoTable(idx) {
        let title = document.getElementById("bagName");
        let table = document.getElementById("bagInfoTable");

        title.innerHTML = files[idx].filename;
        table.innerHTML = "";

        let info = files[idx].info[1];
        for (let topic in info) {
            addToTable(table, [topic, info[topic][0], info[topic][1], info[topic][3]]);
        }
    }

    function showFileDialog() {
        function addFilesToTable(str) {
            let data = JSON.parse(str);
            let table = document.getElementById("fileTable");
            console.log(data);
            for (let idx = 0; idx < data.length; idx++) {
                let filename = data[idx];
                files.push({ filename: filename });
                console.log("getting info for bag idx" + (files.length - 1));
                if (idx == data.length - 1)
                    getBagInfo(files.length - 1, () => { showBagInfoTable(files.length - 1) });
                else
                    getBagInfo(files.length - 1, () => { });

                addToTable(table, [filename], "showBagInfoTable(" + (files.length - 1) + ")");
            }
            hideLoading();
            if (data.length > 0)
                completedStep(1);
        }
        showLoading("Select file...");
        makeRequest("/selectBag", addFilesToTable)
    }

    function getBagInfo(fileIdx, callback) {
        function saveBagInfo(str) {
            let data = JSON.parse(str);
            files[fileIdx].info = data;
            callback();
        }
        makeRequest("bagInfo?path=" + encodeURIComponent(files[fileIdx].filename), saveBagInfo);
    }

    window.onload = function () {
        showPanel(0);
        completedStep(0);
    }

    function makeRequest(url, callback) {
        let httpRequest = new XMLHttpRequest();
        if (!httpRequest)
            return false;

        function receivedResponse() {
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    // alert(httpRequest.responseText);
                    console.log("RECEIVED RESPONSE: " + httpRequest.responseText);
                    callback(httpRequest.responseText);
                } else {
                    alert('Internal error: \n\n' + httpRequest.responseText + "\n\nApp will restart...");
                    location.reload();
                }
            }
        }

        httpRequest.timeout = 0
        httpRequest.onreadystatechange = receivedResponse;
        console.log("SENDING REQUEST: " + url);
        httpRequest.open('GET', url);
        httpRequest.send();
    }

    let allTopicsTableItemCount = 0;
    let allTopicsTable = document.querySelector('#allTopicsTableOuter');
    let headerCheckbox = allTopicsTable.querySelector('thead .mdl-data-table__select input');
    let headerCheckHandler = function (event) {
        let boxes = allTopicsTable.querySelectorAll('tbody .mdl-data-table__select');
        if (event.target.checked) {
            for (let i = 0, length = boxes.length; i < length; i++) {
                boxes[i].MaterialCheckbox.check();
                boxes[i].MaterialCheckbox.updateClasses_();
                completedStep(2);
            }
        } else {
            for (let i = 0, length = boxes.length; i < length; i++) {
                boxes[i].MaterialCheckbox.uncheck();
                boxes[i].MaterialCheckbox.updateClasses_();
                completedStep(1);
            }
        }
    };

    let itemCheckHandler = function (event) {
        let boxes = allTopicsTable.querySelectorAll('tbody .is-checked');
        let headerCheckbox = allTopicsTable.querySelector('thead .mdl-data-table__select');
        // console.log("this many boxes checked: " + boxes.length);
        if (boxes.length === allTopicsTableItemCount) {
            headerCheckbox.MaterialCheckbox.check();
            headerCheckbox.MaterialCheckbox.updateClasses_();
        } else {
            headerCheckbox.MaterialCheckbox.uncheck();
            headerCheckbox.MaterialCheckbox.updateClasses_();
        }
        if (boxes.length === 0) {
            completedStep(1);
        } else {
            completedStep(2);
        }
    }
    headerCheckbox.addEventListener('change', headerCheckHandler);

    let completedStepIdx = 0;
    const greenCheckIcon = `<i style="margin: 5px; color: green; float:right;" class="fa fa-check-circle fa-lg" aria-hidden="true"></i>`;
    const orangeBangIcon = `<i style="margin: 5px; color: #ff6200; float:right;" class="fa fa-exclamation-triangle fa-lg" aria-hidden="true"></i>`;
    function completedStep(idx) {
        completedStepIdx = idx;
        let text = [``, `<b>1. Select bags</b>`, `<b>2. Select topics</b>`, `<b>3. Export options</b>`, `<b>4. Finish</b>`];
        if (idx === 0) {
            text[1] += orangeBangIcon;
        } else if (idx === 1) {
            text[1] += greenCheckIcon;
            text[2] += orangeBangIcon;
        } else if (idx === 2) {
            text[1] += greenCheckIcon;
            text[2] += greenCheckIcon;
            text[3] += orangeBangIcon;
        } else if (idx === 3) {
            text[1] += greenCheckIcon;
            text[2] += greenCheckIcon;
            text[3] += greenCheckIcon;
            text[4] += orangeBangIcon;
        } else {
            text[1] += greenCheckIcon;
            text[2] += greenCheckIcon;
            text[3] += greenCheckIcon;
            text[4] += greenCheckIcon;
        }
        for (let i = 1; i < 5; i++) {
            document.getElementById("nav" + i).innerHTML = text[i];
        }
    }

    function checkEnableStandstill() {
        let checkbox = document.getElementById("standstillSwitch");
        let checkboxLabel = document.getElementById("standstillSwitchLabel");

        if (!document.getElementById("oneRunSwitch").checked && checkbox.checked) {
            checkbox.checked = false;
            showAlert("Can't enable this feature", "This feature requires all the files to be in one run. <br>Go to the step 1 and enable 'Treat as one run'", 'warning', 'Got it!', () => { showPanel(1) })
        }
        if (checkbox.checked) {
            checkboxLabel.innerHTML = `Enabled`;
            document.getElementById("standstillTimeInput").parentElement.parentElement.classList.remove("disabled");
        } else {
            checkboxLabel.innerHTML = `Disabled`;
            document.getElementById("standstillTimeInput").parentElement.parentElement.classList.add("disabled");
        }
    }



    function checkTreatAsOneRun() {
        let checkbox = document.getElementById("oneRunSwitch");
        if (!checkbox.checked) {
            document.getElementById("standstillSwitch").parentElement.MaterialSwitch.off();
        }
    }

    function showAlert(title, text, icon, buttonText, callback) {
        Swal.fire({
            title: title,
            html: text,
            icon: icon,
            confirmButtonColor: '#3085d6',
            confirmButtonText: buttonText
        }).then((result) => {
            callback();
        });
    }

    function showLoading(title) {
        Swal.fire({
            title: title,
            html: '',
            allowEscapeKey: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        }).then((result) => {
        });
    }

    function hideLoading() {
        Swal.close();
    }

</script>
<style>
    .demo-card-wide.mdl-card {
        width: 512px;
    }

    .demo-card-wide>.mdl-card__title {
        color: #fff;
        height: 176px;
        background-image: linear-gradient(to bottom right, rgb(98, 101, 255), rgb(166, 0, 255));

    }

    .demo-card-wide>.mdl-card__menu {
        color: #fff;
    }

    .center {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        height: fit-content;
        width: fit-content;
    }

    .center1 {
        position: relative;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    .column {
        float: left;
        width: fit-content;
        height: fit-content;
        padding-left: 7%;
    }

    /* Clear floats after the columns */
    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    #fileTable td {
        cursor: pointer;
    }

    .disabled {
        pointer-events: none;
        opacity: 0.4;
    }
</style>

</html>